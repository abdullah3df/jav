<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>معاينة كود — موبايل/تابلت/ديسكتوب</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f17;--panel:#0f1626;--line:#22314d;--text:#e6edf3;--muted:#9aa6b2;
    --accent:#60a5fa;--green:#22c55e;--red:#ef4444;--chip:#1a263e;--surface:#0e1a2c
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Cairo",system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0e1526,#0e1526dd);border-bottom:1px solid var(--line);backdrop-filter:saturate(1.1) blur(10px)}
  .head{max-width:1400px;margin:auto;display:flex;gap:12px;align-items:center;padding:10px 14px}
  .logo{width:34px;height:34px;border-radius:10px;background:conic-gradient(from 120deg,#3b82f6,#22c55e,#fde047,#f43f5e,#3b82f6)}
  .brand{font-weight:800}
  .spacer{flex:1}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#0b1220;border:1px solid #ffffff1a;color:#cbd5e1;padding:8px 12px;border-radius:999px;font-size:13px}

  .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .btn:hover{filter:brightness(1.05)}
  .btn.play{background:linear-gradient(180deg,#22c55e,#16a34a);color:#fff}
  .btn.save{background:linear-gradient(180deg,#60a5fa,#3b82f6);color:#fff}
  .btn.ghost{background:#0b1220;border:1px solid #ffffff1a;color:#cbd5e1}
  .btn.warn{background:linear-gradient(180deg,#ef4444,#dc2626);color:#fff}

  .main{max-width:1400px;margin:auto;padding:14px;display:grid;gap:12px;grid-template-columns:1.05fr 1fr}
  @media (max-width:1100px){.main{grid-template-columns:1fr}}

  .panel{background:linear-gradient(180deg,#0f1626,#0d1422);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px #00000030;overflow:hidden;min-height:0;display:flex;flex-direction:column}
  .tabs{display:flex;gap:8px;padding:8px 10px;border-bottom:1px solid var(--line);background:#0e1a2c}
  .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#cbd5e1;font-weight:700;cursor:pointer}
  .tab.active{background:#132036;border-color:#3a4a6b;color:#fff}
  .editor{position:relative;height:360px;display:none}
  .editor.active{display:block}
  textarea{position:absolute;inset:0;width:100%;height:100%;border:none;outline:none;resize:none;background:#0b1220;color:#e6edf3;font:14px/1.6 ui-monospace,Consolas,monospace;padding:14px}
  .status{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px 12px;border-top:1px solid var(--line);background:#0e1a2c;color:#9fb3d9;font-size:12px}

  /* Preview side */
  .prev-toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px;border-bottom:1px solid var(--line);background:#0e1a2c}
  .chip{padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #ffffff1a;color:#cbd5e1;font-size:12px;display:inline-flex;gap:6px;align-items:center}
  .chip input, .chip select{accent-color:#60a5fa;background:#0b1220;color:#cbd5e1;border:1px solid #ffffff1a;border-radius:10px;padding:6px 10px}
  .tool-spacer{flex:1}

  /* Device frame */
  .device-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:14px}
  .stage{position:relative;display:inline-block;transform-origin:top center}
  .device{
    position:relative;background:#0a0a0a;border-radius:34px;padding:16px;border:1px solid #222;
    box-shadow:0 20px 60px rgba(0,0,0,.6), inset 0 0 0 2px #1a1a1a;
  }
  .device::before{ /* notch */
    content:""; position:absolute; top:8px; left:50%; transform:translateX(-50%);
    width:120px; height:18px; background:#0a0a0a; border-radius:0 0 12px 12px; border:1px solid #1d1d1d; border-top:none;
  }
  .screen{
    background:#fff;border-radius:24px; overflow:hidden; box-shadow:inset 0 0 0 1px #333;
  }
  iframe{border:0; display:block; width:100%; height:100%}

  .hint{color:var(--muted); font-size:12px; padding:0 10px 10px}
</style>
</head>
<body>
  <header>
    <div class="head">
      <div class="logo"></div>
      <div class="brand">معاينة كود — موبايل/تابلت/ديسكتوب</div>
      <div class="spacer"></div>
      <span id="autosave" class="pill">💾 حفظ تلقائي مفعّل</span>
      <button id="run" class="btn play" title="تشغيل (Ctrl+Enter)">تشغيل</button>
      <button id="download" class="btn save" title="تنزيل HTML واحد">تنزيل</button>
      <button id="reset" class="btn warn" title="إرجاع القالب">إعادة ضبط</button>
    </div>
  </header>

  <div class="main">
    <!-- المحرر -->
    <section class="panel">
      <div class="tabs">
        <button class="tab active" data-tab="html">HTML</button>
        <button class="tab" data-tab="css">CSS</button>
        <button class="tab" data-tab="js">JS</button>
        <div class="spacer"></div>
        <label class="chip"><input type="checkbox" id="autoRun" checked> تشغيل تلقائي</label>
        <label class="chip"><input type="checkbox" id="useTailwind" checked> إضافة Tailwind</label>
        <label class="chip"><input type="checkbox" id="useNormalize"> Normalize CSS</label>
      </div>

      <div class="editor active" id="htmlPanel"><textarea id="htmlCode"></textarea></div>
      <div class="editor" id="cssPanel"><textarea id="cssCode"></textarea></div>
      <div class="editor" id="jsPanel"><textarea id="jsCode"></textarea></div>

      <div class="status">
        <div>⌨️ اختصارات: <b>Ctrl+Enter</b> تشغيل — <b>Ctrl+S</b> تنزيل — <b>Ctrl+1/2/3</b> تنقّل</div>
        <div id="lines">0 سطر</div>
      </div>
    </section>

    <!-- المعاينة مع إطار جهاز -->
    <section class="panel">
      <div class="prev-toolbar">
        <label class="chip">الجهاز:
          <select id="devicePreset">
            <option value="390x844">iPhone 14 — 390×844</option>
            <option value="412x915">Pixel 7 — 412×915</option>
            <option value="430x932">iPhone 14 Pro Max — 430×932</option>
            <option value="768x1024">iPad — 768×1024</option>
            <option value="1024x1366">iPad Pro — 1024×1366</option>
            <option value="1280x800">Desktop Small — 1280×800</option>
            <option value="1440x900">Desktop — 1440×900</option>
          </select>
        </label>
        <label class="chip"><input type="checkbox" id="rotate"> تدوير (أفقي)</label>
        <label class="chip">الزوم:
          <select id="zoom">
            <option>100%</option><option>90%</option><option>80%</option><option>75%</option>
            <option selected>70%</option><option>60%</option><option>50%</option><option>40%</option>
          </select>
        </label>
        <div class="tool-spacer"></div>
        <button id="openWindow" class="btn ghost">فتح في نافذة مستقلة</button>
      </div>

      <div class="device-wrap">
        <div id="stage" class="stage">
          <div id="device" class="device">
            <div id="screen" class="screen" style="width:390px;height:844px">
              <iframe id="preview" title="معاينة"></iframe>
            </div>
          </div>
        </div>
      </div>
      <div class="hint">نصيحة: عند المعاينة للموبايل، تأكد أن وثيقتك تحتوي على وسم <code>&lt;meta name="viewport" ...&gt;</code>. سنضيفه تلقائيًا إذا لم يوجد.</div>
    </section>
  </div>

<script>
  // عناصر
  const $ = s => document.querySelector(s);
  const runBtn = $('#run'), downloadBtn = $('#download'), resetBtn = $('#reset'), openWindowBtn = $('#openWindow');
  const htmlA = $('#htmlCode'), cssA = $('#cssCode'), jsA = $('#jsCode'), linesEl = $('#lines'), autosaveTag = $('#autosave');
  const autoRun = $('#autoRun'), useTailwind = $('#useTailwind'), useNormalize = $('#useNormalize');
  const preview = $('#preview'); const screen = $('#screen'); const stage = $('#stage');
  const devicePreset = $('#devicePreset'); const rotate = $('#rotate'); const zoomSel = $('#zoom');

  // حالة
  const LS = 'mobile_preview_v2';
  const defaults = {
    html: `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تجربتي (موبايل)</title>
  <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:16px}</style>
</head>
<body>
  <header style="position:sticky;top:0;background:#fff;padding:12px;border-bottom:1px solid #eee;z-index:10">
    <strong>ترويسة</strong>
  </header>

  <main class="p-4">
    <h1 style="color:#1d4ed8">👋 أهلاً بك</h1>
    <p>هذه معاينة مخصّصة للموبايل. جرّب تكبير/تصغير وتدوير الجهاز من الشريط العلوي.</p>
    <button onclick="alert('Hi!')" style="background:#1d4ed8;color:#fff;border:none;padding:.6rem 1rem;border-radius:.5rem">زر</button>
  </main>
</body>
</html>`,
    css: `/* CSS إضافي */
h1{margin-top:16px}
button:hover{filter:brightness(1.05)}`,
    js: `console.log('Mobile preview ready!');`
  };

  function load(){ try{ return JSON.parse(localStorage.getItem(LS)) ?? {...defaults} }catch{ return {...defaults} } }
  function save(){
    localStorage.setItem(LS, JSON.stringify({ html: htmlA.value, css: cssA.value, js: jsA.value }));
    autosaveTag.textContent = '💾 تم الحفظ';
    clearTimeout(saveTO); saveTO = setTimeout(()=> autosaveTag.textContent='💾 حفظ تلقائي مفعّل', 800);
  }
  function countLines(){
    const total = htmlA.value.split('\n').length + cssA.value.split('\n').length + jsA.value.split('\n').length;
    linesEl.textContent = total + ' سطر';
  }

  const st = load(); htmlA.value=st.html; cssA.value=st.css; jsA.value=st.js; countLines();

  // تبويبات
  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
      document.querySelectorAll('.editor').forEach(e=>e.classList.remove('active'));
      document.getElementById(t.dataset.tab+'Panel').classList.add('active');
    });
  });

  // أبعاد الجهاز + زوم + تدوير
  function parsePreset(v){
    const [w,h] = v.split('x').map(n=>parseInt(n,10));
    return {w,h};
  }
  function applyDeviceSize(){
    let {w,h} = parsePreset(devicePreset.value);
    if(rotate.checked){ [w,h] = [h,w]; }
    screen.style.width = w + 'px';
    screen.style.height = h + 'px';
    // زوم كامل المسرح (CSS Transform) ليظهر الجهاز بحجم مناسب
    const z = parseInt(zoomSel.value,10) / 100;
    stage.style.transform = `scale(${z})`;
  }
  devicePreset.addEventListener('change', applyDeviceSize);
  rotate.addEventListener('change', applyDeviceSize);
  zoomSel.addEventListener('change', applyDeviceSize);

  // بناء صفحة المعاينة (مع إصلاح viewport تلقائي)
  function ensureViewportHead(html){
    // إن لم يجد meta viewport، نضيف واحدًا
    if(!/<meta[^>]+name=["']viewport["']/i.test(html)){
      html = html.replace(/<head[^>]*>/i, m => `${m}\n<meta name="viewport" content="width=device-width, initial-scale=1">`);
      if(!/<head/i.test(html)){
        // لا يوجد <head> أصلاً
        html = `<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"></head><body>${html}</body></html>`;
      }
    }
    return html;
  }

  function bundle(){
    const links=[];
    if(useNormalize.checked){
      links.push('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">');
    }
    if(useTailwind.checked){
      links.push('<script src="https://cdn.tailwindcss.com"></script>');
    }

    const inj = `
<style>
${cssA.value}
</style>
<script>
${jsA.value}
<\/script>`;

    let base = htmlA.value.trim();
    base = ensureViewportHead(base);

    if (/<\/head>/i.test(base)) {
      return base.replace(/<\/head>/i, links.join('\n')+'\n</head>').replace('</body>', inj+'\n</body>');
    }
    // إن لم يضع المستخدم هيكل HTML كامل، نغلفه
    return `<!DOCTYPE html><html lang="ar" dir="rtl"><head>${links.join('\n')}<meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1"></head><body>${base}${inj}</body></html>`;
  }

  // تشغيل (srcdoc موثوق)
  function run(){ preview.srcdoc = bundle(); }
  run(); // أول مرة

  let debounce=null, saveTO=null;
  [htmlA,cssA,jsA,useTailwind,useNormalize].forEach(el=>{
    const evt = el.type === 'checkbox' ? 'change' : 'input';
    el.addEventListener(evt, ()=>{ save(); countLines(); if(autoRun.checked){ clearTimeout(debounce); debounce=setTimeout(run, 200); } });
  });

  runBtn.addEventListener('click', run);

  // تنزيل ملف HTML واحد
  function download(name, text){
    const blob = new Blob([text], {type:'text/html;charset=utf-8'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
  }
  downloadBtn.addEventListener('click', ()=> download('project.html', bundle()));

  // فتح في نافذة مستقلة (مع srcdoc لضمان العمل)
  openWindowBtn.addEventListener('click', ()=>{
    const html = bundle();
    const w = window.open('', '_blank', 'noopener,width=420,height=900');
    if(!w){ alert('المتصفح منع النافذة المنبثقة. اسمح بها مؤقتًا.'); return; }
    // نستخدم doc.write هنا بgesture المستخدم (زر) فمسموح ومضمون
    w.document.open(); w.document.write(html); w.document.close();
  });

  // اختصارات
  window.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); run(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); download('project.html', bundle()); }
    if((e.ctrlKey||e.metaKey) && ['1','2','3'].includes(e.key)){
      e.preventDefault();
      const map={1:'html',2:'css',3:'js'};
      const tab=map[e.key];
      document.querySelector(`.tab[data-tab="${tab}"]`).click();
    }
  });

  // تفعيل أبعاد الجهاز أولًا
  applyDeviceSize();
</script>
</body>
</html>
