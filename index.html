<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>مربع كود + معاينة فورية</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<!-- تمييز الأكواد لأي لغة -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<style>
  :root{
    --bg:#0b0f17;--panel:#0f1626;--line:#22314d;--text:#e6edf3;--muted:#9aa6b2;--accent:#60a5fa
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Cairo",system-ui,-apple-system,"Segoe UI",Roboto,Arial;display:flex;flex-direction:column}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0e1526,#0e1526dd);border-bottom:1px solid var(--line);backdrop-filter:saturate(1.1) blur(10px)}
  .head{max-width:1200px;margin:auto;display:flex;gap:10px;align-items:center;padding:10px 14px}
  .brand{font-weight:800}
  .spacer{flex:1}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#0b1220;border:1px solid #ffffff1a;color:#cbd5e1;padding:8px 12px;border-radius:999px;font-size:12px}

  .main{max-width:1200px;margin:auto;padding:14px;display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media (max-width:960px){.main{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,#0f1626,#0d1422);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;min-height:0}
  .card-head{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid var(--line)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,input[type="text"]{background:#0b1220;border:1px solid #ffffff1a;color:#e6edf3;border-radius:10px;padding:8px 10px;outline:none}
  .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.run{background:linear-gradient(180deg,#22c55e,#16a34a);color:#fff}
  .btn.save{background:linear-gradient(180deg,#60a5fa,#3b82f6);color:#fff}
  .btn.ghost{background:#0b1220;border:1px solid #ffffff1a;color:#cbd5e1}

  textarea{
    width:100%;height:60vh;min-height:320px;background:#0b1220;color:#e6edf3;border:none;outline:none;
    font:14px/1.6 ui-monospace,Consolas,monospace;padding:14px;resize:vertical
  }

  /* المعاينة */
  .preview{display:flex;flex-direction:column;min-height:0}
  .toolbar{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid var(--line);background:#0e1a2c}
  iframe{flex:1;border:0;background:white;height:60vh;min-height:320px}
  .codebox{flex:1;overflow:auto;background:#0b1220;border-top:1px solid var(--line)}
  pre{margin:0;padding:14px}
</style>
</head>
<body>
  <header>
    <div class="head">
      <div class="brand">مربع كود + معاينة فورية</div>
      <div class="spacer"></div>
      <span class="pill">Ctrl+Enter تشغيل — Ctrl+S تنزيل</span>
    </div>
  </header>

  <div class="main">
    <!-- الإدخال -->
    <section class="card">
      <div class="card-head row">
        <label class="pill">النمط:
          <select id="mode">
            <option value="auto" selected>تلقائي (موصى به)</option>
            <option value="html">HTML (وثيقة كاملة)</option>
            <option value="fragment">HTML (جزء/مكوّن)</option>
            <option value="markdown">Markdown</option>
            <option value="code">كود (أي لغة)</option>
          </select>
        </label>
        <label class="pill"><input type="checkbox" id="autoRun" checked> تشغيل تلقائي</label>
        <div class="spacer"></div>
        <input id="filename" type="text" value="my-code.html" title="اسم الملف عند التنزيل" />
        <button id="downloadBtn" class="btn save">تنزيل</button>
        <button id="runBtn" class="btn run">تشغيل</button>
      </div>
      <textarea id="code" placeholder="ألصِق الكود هنا. HTML/Markdown/أي لغة في نفس المربع."></textarea>
    </section>

    <!-- المخرجات -->
    <section class="card preview">
      <div class="toolbar row">
        <span class="pill" id="status">جاهز</span>
        <div class="spacer"></div>
        <button id="openWin" class="btn ghost">فتح المعاينة في نافذة</button>
      </div>
      <!-- لو HTML/Markdown نستخدم iframe؛ لو كود عادي نعرضه ملوّن -->
      <iframe id="frame" title="المعاينة"></iframe>
      <div id="codeView" class="codebox" style="display:none">
        <pre><code id="hlcode" class="hljs"></code></pre>
      </div>
    </section>
  </div>

<script>
  const $ = s => document.querySelector(s);
  const codeEl = $('#code');
  const modeEl = $('#mode');
  const frame = $('#frame');
  const codeView = $('#codeView');
  const hlcode = $('#hlcode');
  const statusEl = $('#status');
  const runBtn = $('#runBtn');
  const downloadBtn = $('#downloadBtn');
  const filenameEl = $('#filename');
  const autoRun = $('#autoRun');
  const openWin = $('#openWin');

  const LS = 'one_box_preview_v1';

  // قالب لجزء HTML (نلفّه بوثيقة جاهزة)
  function wrapFragment(html){
    return `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Preview</title>
</head>
<body>
${html}
</body>
</html>`;
  }

  // تحويل Markdown بسيط (عناوين وروابط وفقرة وكود محاط ``` )
  function mdToHtml(md){
    // حماية الكود الثلاثي
    const fences = [];
    md = md.replace(/```([\\s\\S]*?)```/g, (_, block)=>{
      fences.push(block); return `__FENCE_${fences.length-1}__`;
    });
    // عناوين
    md = md.replace(/^###### (.*)$/gm,'<h6>$1</h6>')
           .replace(/^##### (.*)$/gm,'<h5>$1</h5>')
           .replace(/^#### (.*)$/gm,'<h4>$1</h4>')
           .replace(/^### (.*)$/gm,'<h3>$1</h3>')
           .replace(/^## (.*)$/gm,'<h2>$1</h2>')
           .replace(/^# (.*)$/gm,'<h1>$1</h1>');
    // غامق ومائل وروابط
    md = md.replace(/\\*\\*(.+?)\\*\\*/g,'<strong>$1</strong>')
           .replace(/\\*(.+?)\\*/g,'<em>$1</em>')
           .replace(/`([^`]+)`/g,'<code>$1</code>')
           .replace(/\\[(.+?)\\]\\((.+?)\\)/g,'<a href="$2" target="_blank">$1</a>');
    // فقرات
    md = md.split(/\\n{2,}/).map(p=>{
      if(/^<h\\d|^<ul|^<ol|^<pre|^<blockquote/.test(p.trim())) return p;
      return '<p>'+p.replace(/\\n/g,'<br>')+'</p>';
    }).join('\\n');

    // إعادة الكود
    md = md.replace(/__FENCE_(\\d+)__/g, (_,i)=>{
      const safe = fences[i].replace(/[&<>]/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[s]));
      return '<pre><code class="hljs">'+safe+'</code></pre>';
    });

    return `<!DOCTYPE html><html lang="ar" dir="rtl"><head>
<meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
</head><body style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:18px;line-height:1.8">
${md}
<script>document.querySelectorAll('pre code').forEach((el)=>window.hljs && hljs.highlightElement(el));<\/script>
</body></html>`;
  }

  // تحديد النوع تلقائيًا
  function detectMode(text){
    const t = text.trim();
    if (/<!DOCTYPE|<html|<head|<body/i.test(t)) return 'html';
    if (/<[a-z][\s\S]*>/i.test(t)) return 'fragment';
    if (/^#{1,6} |```|\\*\\*.+\\*\\*|\\[(.+?)\\]\\((.+?)\\)/m.test(t)) return 'markdown';
    return 'code';
  }

  function setStatus(msg){ statusEl.textContent = msg; }

  function run(){
    const raw = codeEl.value;
    if (!raw.trim()){
      // نظهر صفحة فارغة لطيفة بدل لا شيء
      frame.style.display = ''; codeView.style.display='none';
      frame.srcdoc = wrapFragment('<main style="padding:18px;font-family:system-ui">ألصِق كودك على اليسار ثم اضغط تشغيل.</main>');
      setStatus('لا يوجد كود — عرض صفحة توجيهية'); 
      return;
    }

    const mode = (modeEl.value === 'auto') ? detectMode(raw) : modeEl.value;

    if (mode === 'html'){
      frame.style.display = ''; codeView.style.display='none';
      frame.srcdoc = raw;
      setStatus('معاينة HTML (وثيقة كاملة)');
    } else if (mode === 'fragment'){
      frame.style.display = ''; codeView.style.display='none';
      frame.srcdoc = wrapFragment(raw);
      setStatus('معاينة HTML (جزء/مكوّن)');
    } else if (mode === 'markdown'){
      frame.style.display = ''; codeView.style.display='none';
      frame.srcdoc = mdToHtml(raw);
      setStatus('معاينة Markdown');
    } else { // code (أي لغة)
      frame.style.display = 'none'; codeView.style.display='';
      hlcode.textContent = raw;
      window.hljs && hljs.highlightElement(hlcode);
      setStatus('عرض الكود (جميع اللغات) مع تمييز ألوان');
    }
    save();
  }

  // تنزيل الملف بزر واحد
  function download(){
    const name = (filenameEl.value || 'my-code.html').trim();
    const blob = new Blob([codeEl.value], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=name; a.click();
    URL.revokeObjectURL(url);
  }

  // حفظ تلقائي
  function save(){
    localStorage.setItem(LS, JSON.stringify({
      code: codeEl.value,
      mode: modeEl.value,
      filename: filenameEl.value
    }));
  }
  function load(){
    try{
      const o = JSON.parse(localStorage.getItem(LS));
      if(!o) return;
      codeEl.value = o.code || '';
      modeEl.value = o.mode || 'auto';
      filenameEl.value = o.filename || 'my-code.html';
    }catch{}
  }

  // أحداث
  let debounce=null;
  [codeEl, modeEl].forEach(el=>{
    const evt = (el===modeEl)? 'change' : 'input';
    el.addEventListener(evt, ()=>{
      clearTimeout(debounce);
      if (autoRun.checked){
        debounce = setTimeout(run, 200);
      }
    });
  });

  runBtn.addEventListener('click', run);
  downloadBtn.addEventListener('click', download);
  openWin.addEventListener('click', ()=>{
    // فتح المعاينة الحالية في نافذة (إن كانت HTML/Markdown)
    const text = codeEl.value;
    const m = (modeEl.value==='auto')? detectMode(text) : modeEl.value;
    if (m==='code'){
      alert('المعاينة الحالية ليست HTML/Markdown. استخدم وضع HTML/Fragment/Markdown لفتح نافذة.');
      return;
    }
    const html = (m==='html')? text : (m==='markdown'? mdToHtml(text) : wrapFragment(text));
    const w = window.open('', '_blank', 'noopener,width=420,height=800');
    if(!w){ alert('المتصفح منع النافذة المنبثقة. اسمح بها مؤقتًا.'); return; }
    w.document.open(); w.document.write(html); w.document.close();
  });

  // اختصارات
  window.addEventListener('keydown',(e)=>{
    if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); run(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); download(); }
  });

  // إقلاع
  load();
  // إن لم يكن هناك أي شيء، ضع أمثلة صغيرة مفيدة
  if(!codeEl.value.trim()){
    codeEl.value =
`<!-- مثال HTML (وثيقة كاملة): ألصق واضغط تشغيل -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>تجربة</title>
  <style>
    body{font-family:system-ui;padding:20px}
    .btn{background:#2563eb;color:#fff;border:none;padding:.6rem 1rem;border-radius:.5rem;cursor:pointer}
  </style>
</head>
<body>
  <h1>مرحبا 👋</h1>
  <p>هذه وثيقة HTML كاملة.</p>
  <button class="btn" onclick="alert('Hi!')">جرّبني</button>
  <script>console.log('جاهز!')</script>
</body>
</html>

<!-- جرّب أيضًا: Markdown
# عنوان H1
- عنصر
- عنصر
**غامق** و *مائل* و \`كود\`
-->

<!-- أو أي لغة أخرى (سيُعرض بألوان):
print("Hello, world!")
function add(a,b){return a+b}
-->`;
  }
  run(); // أول عرض
</script>
</body>
</html>
