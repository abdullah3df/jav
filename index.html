<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…Ø±Ø¨Ø¹ ÙƒÙˆØ¯ + Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙˆØ±ÙŠØ©</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<!-- ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù„Ø£ÙŠ Ù„ØºØ© -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<style>
  :root{
    --bg:#0b0f17;--panel:#0f1626;--line:#22314d;--text:#e6edf3;--muted:#9aa6b2;--accent:#60a5fa
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Cairo",system-ui,-apple-system,"Segoe UI",Roboto,Arial;display:flex;flex-direction:column}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0e1526,#0e1526dd);border-bottom:1px solid var(--line);backdrop-filter:saturate(1.1) blur(10px)}
  .head{max-width:1200px;margin:auto;display:flex;gap:10px;align-items:center;padding:10px 14px}
  .brand{font-weight:800}
  .spacer{flex:1}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#0b1220;border:1px solid #ffffff1a;color:#cbd5e1;padding:8px 12px;border-radius:999px;font-size:12px}

  .main{max-width:1200px;margin:auto;padding:14px;display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media (max-width:960px){.main{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,#0f1626,#0d1422);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;min-height:0}
  .card-head{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid var(--line)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,input[type="text"]{background:#0b1220;border:1px solid #ffffff1a;color:#e6edf3;border-radius:10px;padding:8px 10px;outline:none}
  .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.run{background:linear-gradient(180deg,#22c55e,#16a34a);color:#fff}
  .btn.save{background:linear-gradient(180deg,#60a5fa,#3b82f6);color:#fff}
  .btn.ghost{background:#0b1220;border:1px solid #ffffff1a;color:#cbd5e1}

  textarea{
    width:100%;height:60vh;min-height:320px;background:#0b1220;color:#e6edf3;border:none;outline:none;
    font:14px/1.6 ui-monospace,Consolas,monospace;padding:14px;resize:vertical
  }

  /* Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
  .preview{display:flex;flex-direction:column;min-height:0}
  .toolbar{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid var(--line);background:#0e1a2c}
  iframe{flex:1;border:0;background:white;height:60vh;min-height:320px}
  .codebox{flex:1;overflow:auto;background:#0b1220;border-top:1px solid var(--line)}
  pre{margin:0;padding:14px}
</style>
</head>
<body>
  <header>
    <div class="head">
      <div class="brand">Ù…Ø±Ø¨Ø¹ ÙƒÙˆØ¯ + Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙˆØ±ÙŠØ©</div>
      <div class="spacer"></div>
      <span class="pill">Ctrl+Enter ØªØ´ØºÙŠÙ„ â€” Ctrl+S ØªÙ†Ø²ÙŠÙ„</span>
    </div>
  </header>

  <div class="main">
    <!-- Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
    <section class="card">
      <div class="card-head row">
        <label class="pill">Ø§Ù„Ù†Ù…Ø·:
          <select id="mode">
            <option value="auto" selected>ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…ÙˆØµÙ‰ Ø¨Ù‡)</option>
            <option value="html">HTML (ÙˆØ«ÙŠÙ‚Ø© ÙƒØ§Ù…Ù„Ø©)</option>
            <option value="fragment">HTML (Ø¬Ø²Ø¡/Ù…ÙƒÙˆÙ‘Ù†)</option>
            <option value="markdown">Markdown</option>
            <option value="code">ÙƒÙˆØ¯ (Ø£ÙŠ Ù„ØºØ©)</option>
          </select>
        </label>
        <label class="pill"><input type="checkbox" id="autoRun" checked> ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ</label>
        <div class="spacer"></div>
        <input id="filename" type="text" value="my-code.html" title="Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„" />
        <button id="downloadBtn" class="btn save">ØªÙ†Ø²ÙŠÙ„</button>
        <button id="runBtn" class="btn run">ØªØ´ØºÙŠÙ„</button>
      </div>
      <textarea id="code" placeholder="Ø£Ù„ØµÙÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§. HTML/Markdown/Ø£ÙŠ Ù„ØºØ© ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø±Ø¨Ø¹."></textarea>
    </section>

    <!-- Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª -->
    <section class="card preview">
      <div class="toolbar row">
        <span class="pill" id="status">Ø¬Ø§Ù‡Ø²</span>
        <div class="spacer"></div>
        <button id="openWin" class="btn ghost">ÙØªØ­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠ Ù†Ø§ÙØ°Ø©</button>
      </div>
      <!-- Ù„Ùˆ HTML/Markdown Ù†Ø³ØªØ®Ø¯Ù… iframeØ› Ù„Ùˆ ÙƒÙˆØ¯ Ø¹Ø§Ø¯ÙŠ Ù†Ø¹Ø±Ø¶Ù‡ Ù…Ù„ÙˆÙ‘Ù† -->
      <iframe id="frame" title="Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©"></iframe>
      <div id="codeView" class="codebox" style="display:none">
        <pre><code id="hlcode" class="hljs"></code></pre>
      </div>
    </section>
  </div>

<script>
  const $ = s => document.querySelector(s);
  const codeEl = $('#code');
  const modeEl = $('#mode');
  const frame = $('#frame');
  const codeView = $('#codeView');
  const hlcode = $('#hlcode');
  const statusEl = $('#status');
  const runBtn = $('#runBtn');
  const downloadBtn = $('#downloadBtn');
  const filenameEl = $('#filename');
  const autoRun = $('#autoRun');
  const openWin = $('#openWin');

  const LS = 'one_box_preview_v1';

  // Ù‚Ø§Ù„Ø¨ Ù„Ø¬Ø²Ø¡ HTML (Ù†Ù„ÙÙ‘Ù‡ Ø¨ÙˆØ«ÙŠÙ‚Ø© Ø¬Ø§Ù‡Ø²Ø©)
  function wrapFragment(html){
    return `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Preview</title>
</head>
<body>
${html}
</body>
</html>`;
  }

  // ØªØ­ÙˆÙŠÙ„ Markdown Ø¨Ø³ÙŠØ· (Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ±ÙˆØ§Ø¨Ø· ÙˆÙÙ‚Ø±Ø© ÙˆÙƒÙˆØ¯ Ù…Ø­Ø§Ø· ``` )
  function mdToHtml(md){
    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ
    const fences = [];
    md = md.replace(/```([\\s\\S]*?)```/g, (_, block)=>{
      fences.push(block); return `__FENCE_${fences.length-1}__`;
    });
    // Ø¹Ù†Ø§ÙˆÙŠÙ†
    md = md.replace(/^###### (.*)$/gm,'<h6>$1</h6>')
           .replace(/^##### (.*)$/gm,'<h5>$1</h5>')
           .replace(/^#### (.*)$/gm,'<h4>$1</h4>')
           .replace(/^### (.*)$/gm,'<h3>$1</h3>')
           .replace(/^## (.*)$/gm,'<h2>$1</h2>')
           .replace(/^# (.*)$/gm,'<h1>$1</h1>');
    // ØºØ§Ù…Ù‚ ÙˆÙ…Ø§Ø¦Ù„ ÙˆØ±ÙˆØ§Ø¨Ø·
    md = md.replace(/\\*\\*(.+?)\\*\\*/g,'<strong>$1</strong>')
           .replace(/\\*(.+?)\\*/g,'<em>$1</em>')
           .replace(/`([^`]+)`/g,'<code>$1</code>')
           .replace(/\\[(.+?)\\]\\((.+?)\\)/g,'<a href="$2" target="_blank">$1</a>');
    // ÙÙ‚Ø±Ø§Øª
    md = md.split(/\\n{2,}/).map(p=>{
      if(/^<h\\d|^<ul|^<ol|^<pre|^<blockquote/.test(p.trim())) return p;
      return '<p>'+p.replace(/\\n/g,'<br>')+'</p>';
    }).join('\\n');

    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙˆØ¯
    md = md.replace(/__FENCE_(\\d+)__/g, (_,i)=>{
      const safe = fences[i].replace(/[&<>]/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[s]));
      return '<pre><code class="hljs">'+safe+'</code></pre>';
    });

    return `<!DOCTYPE html><html lang="ar" dir="rtl"><head>
<meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
</head><body style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:18px;line-height:1.8">
${md}
<script>document.querySelectorAll('pre code').forEach((el)=>window.hljs && hljs.highlightElement(el));<\/script>
</body></html>`;
  }

  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  function detectMode(text){
    const t = text.trim();
    if (/<!DOCTYPE|<html|<head|<body/i.test(t)) return 'html';
    if (/<[a-z][\s\S]*>/i.test(t)) return 'fragment';
    if (/^#{1,6} |```|\\*\\*.+\\*\\*|\\[(.+?)\\]\\((.+?)\\)/m.test(t)) return 'markdown';
    return 'code';
  }

  function setStatus(msg){ statusEl.textContent = msg; }

  function run(){
    const raw = codeEl.value;
    if (!raw.trim()){
      // Ù†Ø¸Ù‡Ø± ØµÙØ­Ø© ÙØ§Ø±ØºØ© Ù„Ø·ÙŠÙØ© Ø¨Ø¯Ù„ Ù„Ø§ Ø´ÙŠØ¡
      frame.style.display = ''; codeView.style.display='none';
      frame.srcdoc = wrapFragment('<main style="padding:18px;font-family:system-ui">Ø£Ù„ØµÙÙ‚ ÙƒÙˆØ¯Ùƒ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ø«Ù… Ø§Ø¶ØºØ· ØªØ´ØºÙŠÙ„.</main>');
      setStatus('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ â€” Ø¹Ø±Ø¶ ØµÙØ­Ø© ØªÙˆØ¬ÙŠÙ‡ÙŠØ©'); 
      return;
    }

    const mode = (modeEl.value === 'auto') ? detectMode(raw) : modeEl.value;

    if (mode === 'html'){
      frame.style.display = ''; codeView.style.display='none';
      frame.srcdoc = raw;
      setStatus('Ù…Ø¹Ø§ÙŠÙ†Ø© HTML (ÙˆØ«ÙŠÙ‚Ø© ÙƒØ§Ù…Ù„Ø©)');
    } else if (mode === 'fragment'){
      frame.style.display = ''; codeView.style.display='none';
      frame.srcdoc = wrapFragment(raw);
      setStatus('Ù…Ø¹Ø§ÙŠÙ†Ø© HTML (Ø¬Ø²Ø¡/Ù…ÙƒÙˆÙ‘Ù†)');
    } else if (mode === 'markdown'){
      frame.style.display = ''; codeView.style.display='none';
      frame.srcdoc = mdToHtml(raw);
      setStatus('Ù…Ø¹Ø§ÙŠÙ†Ø© Markdown');
    } else { // code (Ø£ÙŠ Ù„ØºØ©)
      frame.style.display = 'none'; codeView.style.display='';
      hlcode.textContent = raw;
      window.hljs && hljs.highlightElement(hlcode);
      setStatus('Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ¯ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„ØºØ§Øª) Ù…Ø¹ ØªÙ…ÙŠÙŠØ² Ø£Ù„ÙˆØ§Ù†');
    }
    save();
  }

  // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ø²Ø± ÙˆØ§Ø­Ø¯
  function download(){
    const name = (filenameEl.value || 'my-code.html').trim();
    const blob = new Blob([codeEl.value], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=name; a.click();
    URL.revokeObjectURL(url);
  }

  // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ
  function save(){
    localStorage.setItem(LS, JSON.stringify({
      code: codeEl.value,
      mode: modeEl.value,
      filename: filenameEl.value
    }));
  }
  function load(){
    try{
      const o = JSON.parse(localStorage.getItem(LS));
      if(!o) return;
      codeEl.value = o.code || '';
      modeEl.value = o.mode || 'auto';
      filenameEl.value = o.filename || 'my-code.html';
    }catch{}
  }

  // Ø£Ø­Ø¯Ø§Ø«
  let debounce=null;
  [codeEl, modeEl].forEach(el=>{
    const evt = (el===modeEl)? 'change' : 'input';
    el.addEventListener(evt, ()=>{
      clearTimeout(debounce);
      if (autoRun.checked){
        debounce = setTimeout(run, 200);
      }
    });
  });

  runBtn.addEventListener('click', run);
  downloadBtn.addEventListener('click', download);
  openWin.addEventListener('click', ()=>{
    // ÙØªØ­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ù†Ø§ÙØ°Ø© (Ø¥Ù† ÙƒØ§Ù†Øª HTML/Markdown)
    const text = codeEl.value;
    const m = (modeEl.value==='auto')? detectMode(text) : modeEl.value;
    if (m==='code'){
      alert('Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ÙŠØ³Øª HTML/Markdown. Ø§Ø³ØªØ®Ø¯Ù… ÙˆØ¶Ø¹ HTML/Fragment/Markdown Ù„ÙØªØ­ Ù†Ø§ÙØ°Ø©.');
      return;
    }
    const html = (m==='html')? text : (m==='markdown'? mdToHtml(text) : wrapFragment(text));
    const w = window.open('', '_blank', 'noopener,width=420,height=800');
    if(!w){ alert('Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. Ø§Ø³Ù…Ø­ Ø¨Ù‡Ø§ Ù…Ø¤Ù‚ØªÙ‹Ø§.'); return; }
    w.document.open(); w.document.write(html); w.document.close();
  });

  // Ø§Ø®ØªØµØ§Ø±Ø§Øª
  window.addEventListener('keydown',(e)=>{
    if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); run(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); download(); }
  });

  // Ø¥Ù‚Ù„Ø§Ø¹
  load();
  // Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£ÙŠ Ø´ÙŠØ¡ØŒ Ø¶Ø¹ Ø£Ù…Ø«Ù„Ø© ØµØºÙŠØ±Ø© Ù…ÙÙŠØ¯Ø©
  if(!codeEl.value.trim()){
    codeEl.value =
`<!-- Ù…Ø«Ø§Ù„ HTML (ÙˆØ«ÙŠÙ‚Ø© ÙƒØ§Ù…Ù„Ø©): Ø£Ù„ØµÙ‚ ÙˆØ§Ø¶ØºØ· ØªØ´ØºÙŠÙ„ -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ØªØ¬Ø±Ø¨Ø©</title>
  <style>
    body{font-family:system-ui;padding:20px}
    .btn{background:#2563eb;color:#fff;border:none;padding:.6rem 1rem;border-radius:.5rem;cursor:pointer}
  </style>
</head>
<body>
  <h1>Ù…Ø±Ø­Ø¨Ø§ ğŸ‘‹</h1>
  <p>Ù‡Ø°Ù‡ ÙˆØ«ÙŠÙ‚Ø© HTML ÙƒØ§Ù…Ù„Ø©.</p>
  <button class="btn" onclick="alert('Hi!')">Ø¬Ø±Ù‘Ø¨Ù†ÙŠ</button>
  <script>console.log('Ø¬Ø§Ù‡Ø²!')</script>
</body>
</html>

<!-- Ø¬Ø±Ù‘Ø¨ Ø£ÙŠØ¶Ù‹Ø§: Markdown
# Ø¹Ù†ÙˆØ§Ù† H1
- Ø¹Ù†ØµØ±
- Ø¹Ù†ØµØ±
**ØºØ§Ù…Ù‚** Ùˆ *Ù…Ø§Ø¦Ù„* Ùˆ \`ÙƒÙˆØ¯\`
-->

<!-- Ø£Ùˆ Ø£ÙŠ Ù„ØºØ© Ø£Ø®Ø±Ù‰ (Ø³ÙŠÙØ¹Ø±Ø¶ Ø¨Ø£Ù„ÙˆØ§Ù†):
print("Hello, world!")
function add(a,b){return a+b}
-->`;
  }
  run(); // Ø£ÙˆÙ„ Ø¹Ø±Ø¶
</script>
</body>
</html>
