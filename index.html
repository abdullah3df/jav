<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¶Ù…ÙˆÙ†Ø©</title>
<style>
  body{margin:0;background:#0f172a;color:#e2e8f0;font:16px/1.6 system-ui,Segoe UI,Roboto,Arial}
  header{padding:14px 18px;border-bottom:1px solid #1f2a44}
  h1{margin:0;font-size:18px}
  .wrap{max-width:1000px;margin:16px auto;display:grid;gap:12px;grid-template-columns:360px 1fr}
  @media (max-width:900px){.wrap{grid-template-columns:1fr}}
  .panel{background:#0b1220;border:1px solid #1f2a44;border-radius:12px;overflow:hidden}
  .panel .head{padding:8px 10px;border-bottom:1px solid #1f2a44;background:#0e1a2c;display:flex;gap:8px;align-items:center}
  .panel .body{padding:10px}
  textarea{width:100%;height:280px;background:#0b1220;color:#e2e8f0;border:1px solid #22314d;border-radius:8px;padding:10px;resize:vertical;font-family:ui-monospace,Consolas,monospace}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{border:0;border-radius:10px;padding:9px 14px;font-weight:700;cursor:pointer}
  .btn.run{background:#22c55e;color:#fff}
  .btn.save{background:#3b82f6;color:#fff}
  .btn.open{background:#0b1220;color:#cbd5e1;border:1px solid #22314d}
  .pill{padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #22314d;color:#cbd5e1;font-size:12px}
  iframe{width:100%;height:520px;border:0;background:#fff;border-radius:12px}
</style>
</head>
<body>
  <header><h1>Ù…Ø¹Ø§ÙŠÙ†Ø© ÙƒÙˆØ¯ â€” ØªØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ù‹Ø§</h1></header>

  <div class="wrap">
    <!-- Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
    <section class="panel">
      <div class="head row">
        <span class="pill">1) Ø£Ù„ØµÙÙ‚ ÙƒÙˆØ¯Ùƒ</span>
      </div>
      <div class="body">
        <textarea id="code"><h1>Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹</h1>
<p>Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„. ÙŠÙ…ÙƒÙ†Ùƒ ÙˆØ¶Ø¹ HTML ÙƒØ§Ù…Ù„ Ø£Ùˆ Ø¬Ø²Ø¡ HTML.</p>
<button onclick="alert('Ø¹Ù…Ù„Øª!')">Ø¬Ø±Ù‘Ø¨ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button></textarea>
        <div class="row" style="margin-top:10px">
          <label class="pill"><input type="checkbox" id="autorun" checked> ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ</label>
          <button id="run" class="btn run">ØªØ´ØºÙŠÙ„</button>
          <button id="open" class="btn open">ÙØªØ­ ÙÙŠ Ù†Ø§ÙØ°Ø©</button>
          <button id="save" class="btn save">ØªÙ†Ø²ÙŠÙ„</button>
        </div>
        <small style="color:#94a3b8;display:block;margin-top:6px">Ø§Ø®ØªØµØ§Ø±: Ctrl+Enter Ù„Ù„ØªØ´ØºÙŠÙ„ â€” Ctrl+S Ù„Ù„ØªÙ†Ø²ÙŠÙ„</small>
      </div>
    </section>

    <!-- Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
    <section class="panel">
      <div class="head row">
        <span class="pill" id="status">Ø¬Ø§Ù‡Ø²</span>
      </div>
      <div class="body">
        <iframe id="view" sandbox="allow-scripts allow-forms allow-modals allow-popups"></iframe>
      </div>
    </section>
  </div>

<script>
  const $ = s => document.querySelector(s);
  const codeEl = $('#code'), view = $('#view'), statusEl = $('#status');
  const runBtn = $('#run'), saveBtn = $('#save'), openBtn = $('#open'), autorun = $('#autorun');

  // ÙŠÙ„ÙÙ‘ Ø£ÙŠ Ø¬Ø²Ø¡ HTML Ø¨ØµÙØ­Ø© ÙƒØ§Ù…Ù„Ø© + meta viewport
  function wrapIfNeeded(html){
    const hasDoc = /<!DOCTYPE|<html[\s>]/i.test(html);
    if (hasDoc) return ensureViewport(html);
    return `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Preview</title>
</head>
<body>
${html}
</body>
</html>`;
  }
  function ensureViewport(html){
    if(!/<meta[^>]+name=["']viewport["']/i.test(html)){
      if(/<head[^>]*>/i.test(html)){
        html = html.replace(/<head[^>]*>/i, m => m + '\n<meta name="viewport" content="width=device-width, initial-scale=1">');
      }else{
        html = `<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"></head><body>${html}</body></html>`;
      }
    }
    return html;
  }

  // ØªØ´ØºÙŠÙ„: srcdoc Ø£ÙˆÙ„Ù‹Ø§ØŒ ÙˆØ¥Ù† Ù„Ù… ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ Ù†Ø³ØªØ®Ø¯Ù… Blob URL
  function run(){
    const raw = codeEl.value || '';
    const html = wrapIfNeeded(raw);
    try{
      // Ø·Ø±ÙŠÙ‚Ø© srcdoc (Ø§Ù„Ø£ÙØ¶Ù„)
      view.removeAttribute('src'); // Ù†Ø­Ø°Ù Ø£ÙŠ src Ù‚Ø¯ÙŠÙ…
      view.srcdoc = html;
      statusEl.textContent = 'Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… srcdoc';
    }catch(e){
      // Ø¨Ø¯ÙŠÙ„ Blob URL
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      view.src = url;
      statusEl.textContent = 'Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Blob URL';
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø±
      view.onload = ()=> URL.revokeObjectURL(url);
    }
  }

  // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ
  function download(){
    const blob = new Blob([wrapIfNeeded(codeEl.value)], {type:'text/html;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'preview.html'; a.click();
    URL.revokeObjectURL(url);
  }

  // ÙØªØ­ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© (ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù„Ø£Ù†Ù‘Ù‡ ÙŠÙÙ†ÙÙ‘ÙØ° Ø¨Ø¶ØºØ· Ø²Ø±)
  function openWindow(){
    const html = wrapIfNeeded(codeEl.value);
    const w = window.open('', '_blank', 'noopener,width=900,height=700');
    if(!w){ alert('Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø©. Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§.'); return; }
    w.document.open(); w.document.write(html); w.document.close();
  }

  // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
  const LS = 'sure_preview_v1';
  function load(){
    try{
      const s = JSON.parse(localStorage.getItem(LS));
      if(s){ codeEl.value = s.code || ''; autorun.checked = !!s.autorun; }
    }catch{}
  }
  function save(){
    localStorage.setItem(LS, JSON.stringify({ code: codeEl.value, autorun: autorun.checked }));
  }

  // Ø£Ø­Ø¯Ø§Ø«
  let deb=null;
  codeEl.addEventListener('input', ()=>{
    save();
    if(autorun.checked){ clearTimeout(deb); deb = setTimeout(run, 150); }
  });
  runBtn.addEventListener('click', run);
  saveBtn.addEventListener('click', download);
  openBtn.addEventListener('click', openWindow);
  autorun.addEventListener('change', save);

  // Ø§Ø®ØªØµØ§Ø±Ø§Øª
  window.addEventListener('keydown', e=>{
    if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); run(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); download(); }
  });

  // Ø¥Ù‚Ù„Ø§Ø¹
  load();
  run();
</script>
</body>
</html>
