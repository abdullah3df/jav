<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>معاينة مضمونة</title>
<style>
  body{margin:0;background:#0f172a;color:#e2e8f0;font:16px/1.6 system-ui,Segoe UI,Roboto,Arial}
  header{padding:14px 18px;border-bottom:1px solid #1f2a44}
  h1{margin:0;font-size:18px}
  .wrap{max-width:1000px;margin:16px auto;display:grid;gap:12px;grid-template-columns:360px 1fr}
  @media (max-width:900px){.wrap{grid-template-columns:1fr}}
  .panel{background:#0b1220;border:1px solid #1f2a44;border-radius:12px;overflow:hidden}
  .panel .head{padding:8px 10px;border-bottom:1px solid #1f2a44;background:#0e1a2c;display:flex;gap:8px;align-items:center}
  .panel .body{padding:10px}
  textarea{width:100%;height:280px;background:#0b1220;color:#e2e8f0;border:1px solid #22314d;border-radius:8px;padding:10px;resize:vertical;font-family:ui-monospace,Consolas,monospace}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{border:0;border-radius:10px;padding:9px 14px;font-weight:700;cursor:pointer}
  .btn.run{background:#22c55e;color:#fff}
  .btn.save{background:#3b82f6;color:#fff}
  .btn.open{background:#0b1220;color:#cbd5e1;border:1px solid #22314d}
  .pill{padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #22314d;color:#cbd5e1;font-size:12px}
  iframe{width:100%;height:520px;border:0;background:#fff;border-radius:12px}
</style>
</head>
<body>
  <header><h1>معاينة كود — تعمل دائمًا</h1></header>

  <div class="wrap">
    <!-- الإدخال -->
    <section class="panel">
      <div class="head row">
        <span class="pill">1) ألصِق كودك</span>
      </div>
      <div class="body">
        <textarea id="code"><h1>مرحبًا 👋</h1>
<p>هذا مثال. يمكنك وضع HTML كامل أو جزء HTML.</p>
<button onclick="alert('عملت!')">جرّب التنبيه</button></textarea>
        <div class="row" style="margin-top:10px">
          <label class="pill"><input type="checkbox" id="autorun" checked> تشغيل تلقائي</label>
          <button id="run" class="btn run">تشغيل</button>
          <button id="open" class="btn open">فتح في نافذة</button>
          <button id="save" class="btn save">تنزيل</button>
        </div>
        <small style="color:#94a3b8;display:block;margin-top:6px">اختصار: Ctrl+Enter للتشغيل — Ctrl+S للتنزيل</small>
      </div>
    </section>

    <!-- المعاينة -->
    <section class="panel">
      <div class="head row">
        <span class="pill" id="status">جاهز</span>
      </div>
      <div class="body">
        <iframe id="view" sandbox="allow-scripts allow-forms allow-modals allow-popups"></iframe>
      </div>
    </section>
  </div>

<script>
  const $ = s => document.querySelector(s);
  const codeEl = $('#code'), view = $('#view'), statusEl = $('#status');
  const runBtn = $('#run'), saveBtn = $('#save'), openBtn = $('#open'), autorun = $('#autorun');

  // يلفّ أي جزء HTML بصفحة كاملة + meta viewport
  function wrapIfNeeded(html){
    const hasDoc = /<!DOCTYPE|<html[\s>]/i.test(html);
    if (hasDoc) return ensureViewport(html);
    return `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Preview</title>
</head>
<body>
${html}
</body>
</html>`;
  }
  function ensureViewport(html){
    if(!/<meta[^>]+name=["']viewport["']/i.test(html)){
      if(/<head[^>]*>/i.test(html)){
        html = html.replace(/<head[^>]*>/i, m => m + '\n<meta name="viewport" content="width=device-width, initial-scale=1">');
      }else{
        html = `<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"></head><body>${html}</body></html>`;
      }
    }
    return html;
  }

  // تشغيل: srcdoc أولًا، وإن لم يدعم المتصفح نستخدم Blob URL
  function run(){
    const raw = codeEl.value || '';
    const html = wrapIfNeeded(raw);
    try{
      // طريقة srcdoc (الأفضل)
      view.removeAttribute('src'); // نحذف أي src قديم
      view.srcdoc = html;
      statusEl.textContent = 'معاينة باستخدام srcdoc';
    }catch(e){
      // بديل Blob URL
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      view.src = url;
      statusEl.textContent = 'معاينة باستخدام Blob URL';
      // تنظيف الرابط المؤقت بعد تحميل الإطار
      view.onload = ()=> URL.revokeObjectURL(url);
    }
  }

  // تنزيل الملف الحالي
  function download(){
    const blob = new Blob([wrapIfNeeded(codeEl.value)], {type:'text/html;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'preview.html'; a.click();
    URL.revokeObjectURL(url);
  }

  // فتح في نافذة جديدة (يعمل دائمًا لأنّه يُنفَّذ بضغط زر)
  function openWindow(){
    const html = wrapIfNeeded(codeEl.value);
    const w = window.open('', '_blank', 'noopener,width=900,height=700');
    if(!w){ alert('المتصفح منع النافذة. اسمح بالنوافذ المنبثقة مؤقتًا.'); return; }
    w.document.open(); w.document.write(html); w.document.close();
  }

  // حفظ تلقائي وتشغيل تلقائي
  const LS = 'sure_preview_v1';
  function load(){
    try{
      const s = JSON.parse(localStorage.getItem(LS));
      if(s){ codeEl.value = s.code || ''; autorun.checked = !!s.autorun; }
    }catch{}
  }
  function save(){
    localStorage.setItem(LS, JSON.stringify({ code: codeEl.value, autorun: autorun.checked }));
  }

  // أحداث
  let deb=null;
  codeEl.addEventListener('input', ()=>{
    save();
    if(autorun.checked){ clearTimeout(deb); deb = setTimeout(run, 150); }
  });
  runBtn.addEventListener('click', run);
  saveBtn.addEventListener('click', download);
  openBtn.addEventListener('click', openWindow);
  autorun.addEventListener('change', save);

  // اختصارات
  window.addEventListener('keydown', e=>{
    if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); run(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); download(); }
  });

  // إقلاع
  load();
  run();
</script>
</body>
</html>
